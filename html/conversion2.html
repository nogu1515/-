<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../css/conversion2.css">
        <title>csv変換ツール</title>
    </head>
    <body>
        <table align="center">
            <tr>
                <th>
                    <div class="title">CSV to JSON Online Converter</div>
                </th>
                <th>
                    <img src="../image/csv_image.png" width="64" height="64">
                    <img src="../image/yajirushi.png" width="64" height="64">
                    <img src="../image/json_icon.png" width="64" height="64">
                </th>
            </tr>
        </table>

        <br><br>

        <table align="center">
            <tr>
                <td colspan="2">
                    <form name="conform">
                        <input name="myfile" type="file" accept=".csv"><br>
                        <textarea name="output" cols="120" rows="30"></textarea>
                    </form>
                </td>
            </tr>
            <tr>
                <td>
                    <button type="button" onclick="formReset()" class="btn btn-solid">クリア</button>
                </td>
                <td class="btn1">
                    <button id="btn3" class="btn btn-solid" download="unknown.csv">ダウンロード</button>
                    <button class="btn btn-solid" id="copy">コピー</button>
                </td>
            </tr>
        </table>
        <script>
            const FS = require('fs')
            const PATH = require('path')

            const csvPath = PATH.join(__dirname, '20220325.csv')

            //csvの中身が１つの文字列として表示される。これを配列に変換する。
            const csvData = FS.readFileSync(csvPath).toString()
            console.log(csvData)
            
            //1つの文字列からデータを分けるために、配列に変換する。改行コードで区切るようにする
            const rows = csvData.split('\r\n')
            console.log(rows)

            //区切ったものを配列に入れていく。
            const prefectures = rows.map(row => {
                const cols = row.split(',')
                return {
                    "type": "Feature",
                    "geometry": {
                    "type": "Point",
                    "coordinates": [
                    cols[11]  
                    ]
                },
                "properties": {
                    No: cols[0],
                    ID: cols[1],
                    業態: cols[2],
                    店舗支店イベント施設名: cols[3],
                    特典等: cols[4],
                    感染予防対策PR: cols[5],
                    北海道飲食店感染防止対策認証制度: cols[6],
                    市町村: cols[7],
                    住所: cols[8],
                    電話番号: cols[9],
                    URL: cols[10],
                    "allowedQueriesPerSecond": 150.0
                }}
            })
            console.log(prefectures)

            //writeFileSyncを用いてJSONファイルを作成する
            const jsonPath = PATH.join(__dirname, '20220325.json')
            FS.writeFileSync(jsonPath, JSON.stringify(prefectures))


            var form = document.forms.conform;
            form.myfile.addEventListener( 'change', function(e) {
                var result = e.target.files[0];
                var reader = new FileReader();
                reader.readAsText( result );
                reader.addEventListener( 'load', function() {
                    form.output.textContent = reader.result;    
                })
            })

            var results = e.target.files;
            var end = e.target.files.length;
            for(var i = 0; i < end; i++) {
                var reader = new FileReader();

                reader.readAsText( results[i] );
                reader.addEventListener('load', function(e) {
                    console.log( e.target.result );
                })
            }

            function formReset() {
                document.conform.reset();
            }
        </script>
    </body>
</html>
